---
title: "SPFL 2018-2019 Results Gameweek 1"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
---

```{r setup, include=FALSE}
library(flexdashboard)
library(RODBC)
library(ggplot2)
library(ggthemes)
library(dplyr)
library(stringi)
library(stringr)
library(glue)
channel <- odbcConnect("SPFL")

dateFrom <- '2018-08-04'
dateTo <- '2018-08-05'
season <- '2018-2019'

GW_results_prem <- sqlQuery(channel, glue::glue("select * from SPFL.dbo.[gameweek_results_v2] ('{dateFrom}', '{dateTo}', 'Premiership', '{season}')"))
GW_results_champ <- sqlQuery(channel, glue::glue("select * from SPFL.dbo.[gameweek_results_v2] ('{dateFrom}', '{dateTo}', 'Championship', '{season}')"))
GW_results_L1 <- sqlQuery(channel, glue::glue("select * from SPFL.dbo.[gameweek_results_v2] ('{dateFrom}', '{dateTo}', 'League 1', '{season}')"))
GW_results_L2 <- sqlQuery(channel, glue::glue("select * from SPFL.dbo.[gameweek_results_v2] ('{dateFrom}', '{dateTo}', 'League 2', '{season}')"))

plot_GW_results <- function(results) {
  
  results$team <- as.character(results$team)
  results$teamColour<- as.character(results$teamColour)
  results$gameID_2<- as.numeric(results$gameID_2)
  
  results <- results[order(results$gameID_2),]
  
  ggplot(data = results) +
    geom_col(aes(x = reorder(team,-gameID_2), y = xG_BT, fill = reorder(team,gameID_2)),
             colour = "black",width = 0.7) +
    scale_fill_manual(values = results$teamColour)+ 
    geom_text(aes(x = reorder(team,-gameID_2), y = xG_BT + 0.28, label = sprintf("%.2f", round(xG_BT,2)))
              ,size = 3
              ,fontface = "plain"
              ,colour= unlist(rapply(list(results$teamColour)
                                     ,function(x) ifelse(x=="white","black",x)
                                     , how = "replace"))) +
    labs(x = "", y = "Expected goals") +
    #facet_grid(gameID ~ competition, scales = "free") +
    theme(strip.background = element_blank(),
          strip.text.y = element_blank(),
          panel.background = element_blank(),
          axis.title.x=element_blank(),
          axis.text.x = element_blank(),
          axis.line.x=element_blank(),
          axis.text.y=element_text(colour = "black",hjust=1, family = "courier"),
          axis.ticks=element_blank(),
          strip.text.x=element_text(size = 12,family = "courier", face = "italic"),
          legend.position="none") +
    coord_flip()

}

ifelse(nrow(GW_results_prem)>0, p1 <- plot_GW_results(GW_results_prem), p1 <- "No games this week.")
ifelse(nrow(GW_results_champ)>0, p2 <- plot_GW_results(GW_results_champ), p2 <- "No games this week.")
ifelse(nrow(GW_results_L1)>0, p3 <- plot_GW_results(GW_results_L1), p3 <- "No games this week.")
ifelse(nrow(GW_results_L2)>0, p4 <- plot_GW_results(GW_results_L2), p4 <- "No games this week.")

```

Premiership
=====================================

```{r, results='asis'}
p1
```

Championship
=====================================

```{r, results='asis'}
p2
```

League 1
=====================================

```{r, results='asis'}
p3
```

League 2
=====================================

```{r, results='asis'}
p4
```
